#!/usr/bin/env npx tsx
/**
 * シンプル建設業務管理パッケージ v2.0 サンプルデータ投入
 */

import 'dotenv/config';
import { LarkClient } from '../src/api/lark-client.js';

async function main() {
  console.log('📦 シンプル建設業務管理 - サンプルデータ投入\n');
  console.log('━'.repeat(50));

  const appId = process.env.LARK_APP_ID!;
  const appSecret = process.env.LARK_APP_SECRET!;
  const appToken = process.env.LARK_BASE_APP_TOKEN!;

  const tableIds = {
    employees: process.env.LARK_TABLE_EMPLOYEES!,
    qualifications: process.env.LARK_TABLE_QUALIFICATIONS!,
    qualificationRecords: process.env.LARK_TABLE_QUALIFICATION_RECORDS!,
    projects: process.env.LARK_TABLE_PROJECTS!,
    tasks: process.env.LARK_TABLE_TASKS!,
  };

  // テーブルIDのチェック
  const missingTables = Object.entries(tableIds).filter(([_, id]) => !id);
  if (missingTables.length > 0) {
    console.error('❌ テーブルIDが設定されていません:');
    missingTables.forEach(([name]) => console.error(`   - ${name}`));
    console.log('\n先に setup-simple-base.ts を実行してください');
    process.exit(1);
  }

  const client = new LarkClient({ appId, appSecret });

  // ========================================
  // 1. 従業員マスタ
  // ========================================
  console.log('\n👤 従業員マスタにサンプルデータを投入中...');
  try {
    const employees = [
      {
        fields: {
          '社員番号': 'E001',
          '氏名': '山田 太郎',
          'フリガナ': 'ヤマダ タロウ',
          '所属': '建築部',
          '役職': '部長',
          '入社日': '2010-04-01',
          '連絡先': '090-1234-5678',
          '状態': '在籍',
        },
      },
      {
        fields: {
          '社員番号': 'E002',
          '氏名': '佐藤 花子',
          'フリガナ': 'サトウ ハナコ',
          '所属': '建築部',
          '役職': '主任',
          '入社日': '2015-04-01',
          '連絡先': '090-2345-6789',
          '状態': '在籍',
        },
      },
      {
        fields: {
          '社員番号': 'E003',
          '氏名': '鈴木 一郎',
          'フリガナ': 'スズキ イチロウ',
          '所属': '土木部',
          '役職': '課長',
          '入社日': '2012-04-01',
          '連絡先': '090-3456-7890',
          '状態': '在籍',
        },
      },
      {
        fields: {
          '社員番号': 'E004',
          '氏名': '高橋 次郎',
          'フリガナ': 'タカハシ ジロウ',
          '所属': '設備部',
          '役職': '一般',
          '入社日': '2020-04-01',
          '連絡先': '090-4567-8901',
          '状態': '在籍',
        },
      },
      {
        fields: {
          '社員番号': 'E005',
          '氏名': '田中 美咲',
          'フリガナ': 'タナカ ミサキ',
          '所属': '管理部',
          '役職': '一般',
          '入社日': '2022-04-01',
          '連絡先': '090-5678-9012',
          '状態': '在籍',
        },
      },
    ];

    await client.batchCreateRecords(appToken, tableIds.employees, employees);
    console.log(`   ✅ ${employees.length}件投入完了`);
  } catch (error) {
    console.log(`   ❌ 失敗: ${(error as Error).message}`);
  }

  // ========================================
  // 2. 資格マスタ
  // ========================================
  console.log('\n📜 資格マスタにサンプルデータを投入中...');
  try {
    const qualifications = [
      {
        fields: {
          '資格コード': 'Q001',
          '資格名': '1級建築施工管理技士',
          'カテゴリ': '国家資格',
          '有効期限管理': false,
          '必須部署': ['建築部'],
          '備考': '建築工事の施工管理に必要',
        },
      },
      {
        fields: {
          '資格コード': 'Q002',
          '資格名': '1級土木施工管理技士',
          'カテゴリ': '国家資格',
          '有効期限管理': false,
          '必須部署': ['土木部'],
          '備考': '土木工事の施工管理に必要',
        },
      },
      {
        fields: {
          '資格コード': 'Q003',
          '資格名': '1級電気工事施工管理技士',
          'カテゴリ': '国家資格',
          '有効期限管理': false,
          '必須部署': ['設備部'],
          '備考': '電気設備工事の施工管理に必要',
        },
      },
      {
        fields: {
          '資格コード': 'Q004',
          '資格名': '職長・安全衛生責任者',
          'カテゴリ': '民間資格',
          '有効期限管理': true,
          '更新周期（年）': 5,
          '必須部署': ['建築部', '土木部', '設備部'],
          '備考': '5年ごとに能力向上教育が必要',
        },
      },
      {
        fields: {
          '資格コード': 'Q005',
          '資格名': 'フォークリフト運転技能',
          'カテゴリ': '国家資格',
          '有効期限管理': false,
          '備考': '1t以上のフォークリフト運転に必要',
        },
      },
      {
        fields: {
          '資格コード': 'Q006',
          '資格名': '玉掛け技能',
          'カテゴリ': '国家資格',
          '有効期限管理': false,
          '備考': '1t以上の玉掛け作業に必要',
        },
      },
    ];

    await client.batchCreateRecords(appToken, tableIds.qualifications, qualifications);
    console.log(`   ✅ ${qualifications.length}件投入完了`);
  } catch (error) {
    console.log(`   ❌ 失敗: ${(error as Error).message}`);
  }

  // ========================================
  // 3. 資格記録
  // ========================================
  console.log('\n📋 資格記録にサンプルデータを投入中...');
  try {
    const records = [
      {
        fields: {
          '従業員名': '山田 太郎',
          '資格名': '1級建築施工管理技士',
          '取得日': '2015-06-15',
          '証明書番号': 'B-2015-12345',
          '状態': '有効',
        },
      },
      {
        fields: {
          '従業員名': '山田 太郎',
          '資格名': '職長・安全衛生責任者',
          '取得日': '2020-03-10',
          '有効期限': '2025-03-10',
          '証明書番号': 'SH-2020-001',
          '状態': '有効',
          '次回更新予定': '2025-02-01',
        },
      },
      {
        fields: {
          '従業員名': '佐藤 花子',
          '資格名': '1級建築施工管理技士',
          '取得日': '2020-06-20',
          '証明書番号': 'B-2020-23456',
          '状態': '有効',
        },
      },
      {
        fields: {
          '従業員名': '鈴木 一郎',
          '資格名': '1級土木施工管理技士',
          '取得日': '2016-06-18',
          '証明書番号': 'C-2016-34567',
          '状態': '有効',
        },
      },
      {
        fields: {
          '従業員名': '高橋 次郎',
          '資格名': 'フォークリフト運転技能',
          '取得日': '2021-08-25',
          '証明書番号': 'FL-2021-456',
          '状態': '有効',
        },
      },
      {
        fields: {
          '従業員名': '高橋 次郎',
          '資格名': '玉掛け技能',
          '取得日': '2021-09-10',
          '証明書番号': 'TK-2021-789',
          '状態': '有効',
        },
      },
    ];

    await client.batchCreateRecords(appToken, tableIds.qualificationRecords, records);
    console.log(`   ✅ ${records.length}件投入完了`);
  } catch (error) {
    console.log(`   ❌ 失敗: ${(error as Error).message}`);
  }

  // ========================================
  // 4. 案件管理
  // ========================================
  console.log('\n🏗️ 案件管理にサンプルデータを投入中...');
  try {
    const projects = [
      {
        fields: {
          '案件番号': 'PJ-2024-001',
          '案件名': '○○ビル新築工事',
          '顧客名': '株式会社○○開発',
          '現場住所': '東京都千代田区丸の内1-1-1',
          '契約金額': 500000000,
          '着工日': '2024-02-01',
          '竣工予定日': '2024-12-31',
          '状態': '進行中',
          '進捗率': 45,
          '責任者': '山田 太郎',
          '担当者': '佐藤 花子',
        },
      },
      {
        fields: {
          '案件番号': 'PJ-2024-002',
          '案件名': '△△マンション改修工事',
          '顧客名': '△△管理組合',
          '現場住所': '東京都渋谷区渋谷2-2-2',
          '契約金額': 80000000,
          '着工日': '2024-04-01',
          '竣工予定日': '2024-09-30',
          '状態': '進行中',
          '進捗率': 70,
          '責任者': '佐藤 花子',
        },
      },
      {
        fields: {
          '案件番号': 'PJ-2024-003',
          '案件名': '□□道路補修工事',
          '顧客名': '○○市役所',
          '現場住所': '神奈川県横浜市中区1-2-3',
          '契約金額': 30000000,
          '着工日': '2024-06-01',
          '竣工予定日': '2024-08-31',
          '状態': '計画中',
          '進捗率': 0,
          '責任者': '鈴木 一郎',
        },
      },
    ];

    await client.batchCreateRecords(appToken, tableIds.projects, projects);
    console.log(`   ✅ ${projects.length}件投入完了`);
  } catch (error) {
    console.log(`   ❌ 失敗: ${(error as Error).message}`);
  }

  // ========================================
  // 5. 工程管理
  // ========================================
  console.log('\n📅 工程管理にサンプルデータを投入中...');
  try {
    const tasks = [
      // PJ-2024-001 の工程
      {
        fields: {
          '案件名': '○○ビル新築工事',
          '工程名': '仮設工事',
          '順序': 1,
          '開始予定日': '2024-02-01',
          '終了予定日': '2024-02-14',
          '開始実績日': '2024-02-01',
          '終了実績日': '2024-02-12',
          '状態': '完了',
          '進捗率': 100,
          '担当者': '佐藤 花子',
        },
      },
      {
        fields: {
          '案件名': '○○ビル新築工事',
          '工程名': '基礎工事',
          '順序': 2,
          '開始予定日': '2024-02-15',
          '終了予定日': '2024-04-30',
          '開始実績日': '2024-02-15',
          '終了実績日': '2024-04-28',
          '状態': '完了',
          '進捗率': 100,
          '担当者': '佐藤 花子',
          '必要資格': '1級建築施工管理技士',
        },
      },
      {
        fields: {
          '案件名': '○○ビル新築工事',
          '工程名': '躯体工事',
          '順序': 3,
          '開始予定日': '2024-05-01',
          '終了予定日': '2024-08-31',
          '開始実績日': '2024-05-01',
          '状態': '進行中',
          '進捗率': 60,
          '担当者': '佐藤 花子',
          '必要資格': '1級建築施工管理技士',
        },
      },
      {
        fields: {
          '案件名': '○○ビル新築工事',
          '工程名': '内装工事',
          '順序': 4,
          '開始予定日': '2024-09-01',
          '終了予定日': '2024-11-30',
          '状態': '未着手',
          '進捗率': 0,
        },
      },
      {
        fields: {
          '案件名': '○○ビル新築工事',
          '工程名': '竣工検査',
          '順序': 5,
          '開始予定日': '2024-12-01',
          '終了予定日': '2024-12-31',
          '状態': '未着手',
          '進捗率': 0,
        },
      },
      // PJ-2024-002 の工程
      {
        fields: {
          '案件名': '△△マンション改修工事',
          '工程名': '足場設置',
          '順序': 1,
          '開始予定日': '2024-04-01',
          '終了予定日': '2024-04-14',
          '開始実績日': '2024-04-01',
          '終了実績日': '2024-04-13',
          '状態': '完了',
          '進捗率': 100,
        },
      },
      {
        fields: {
          '案件名': '△△マンション改修工事',
          '工程名': '外壁補修',
          '順序': 2,
          '開始予定日': '2024-04-15',
          '終了予定日': '2024-06-30',
          '開始実績日': '2024-04-15',
          '終了実績日': '2024-06-28',
          '状態': '完了',
          '進捗率': 100,
        },
      },
      {
        fields: {
          '案件名': '△△マンション改修工事',
          '工程名': '塗装工事',
          '順序': 3,
          '開始予定日': '2024-07-01',
          '終了予定日': '2024-08-31',
          '開始実績日': '2024-07-01',
          '状態': '進行中',
          '進捗率': 50,
        },
      },
      {
        fields: {
          '案件名': '△△マンション改修工事',
          '工程名': '足場解体・清掃',
          '順序': 4,
          '開始予定日': '2024-09-01',
          '終了予定日': '2024-09-30',
          '状態': '未着手',
          '進捗率': 0,
        },
      },
    ];

    await client.batchCreateRecords(appToken, tableIds.tasks, tasks);
    console.log(`   ✅ ${tasks.length}件投入完了`);
  } catch (error) {
    console.log(`   ❌ 失敗: ${(error as Error).message}`);
  }

  // ========================================
  // 完了
  // ========================================
  console.log('\n' + '━'.repeat(50));
  console.log('✨ サンプルデータの投入が完了しました！\n');
  console.log('投入データ:');
  console.log('  ・従業員マスタ: 5名');
  console.log('  ・資格マスタ: 6種類');
  console.log('  ・資格記録: 6件');
  console.log('  ・案件管理: 3件');
  console.log('  ・工程管理: 9件');
  console.log('\nLark Baseを開いて確認してください:');
  console.log(`  ${process.env.LARK_BASE_URL}`);
}

main().catch(console.error);

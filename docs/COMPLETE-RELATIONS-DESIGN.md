# Lark Base 完全版双方向リレーション設計書

## 概要

建設業務フロー全体を網羅する、17テーブル間の完全なリレーション設計です。
全てのリレーションは双方向リンク（DUPLEX_LINK, type: 21）で実装されます。

## テーブル構成

### マスタ系（5テーブル）
1. **発注者マスタ** (`tblPAVzmHZww2bwF`)
2. **資格者マスタ** (`tblqnOY8S3kl2UWa`)
3. **協力会社マスタ** (`tblcUqUzzj4TyaF2`)
4. **資機材マスタ** (`tblUpCKolVWGNVVl`)
5. **工種マスタ** (`tblE5NcaoSreHiiF`)

### 案件・契約系（2テーブル）
6. **案件情報** (`tblAO99IUW4DDbWc`)
7. **工事契約** (`tblzeXSOwQjTY5wt`)

### 工程系（3テーブル）
8. **大工程** (`tbln82ijUjFqUHEe`)
9. **中工程** (`tbl9s3ZtsNZzncSl`)
10. **小工程** (`tblM4zC4WQJTzx8Q`)

### 配置・発注系（3テーブル）
11. **人員配置** (`tblLQbNfEB6Bbimr`)
12. **機材配置** (`tblfV3nrS96l4W0M`)
13. **協力会社発注** (`tblvBHf9bfIES2mw`)

### 実績・記録系（4テーブル）
14. **作業日報** (`tblN7noQWwpz1ZUh`)
15. **安全パトロール** (`tblncJrCIw6mWUJa`)
16. **KY活動記録** (`tblXVVqEJu9OLIKv`)
17. **検査記録** (`tbld5NUYtR5WuwJJ`)

---

## リレーション設計詳細

全36リレーション（双方向）を以下のグループに分類して説明します。

---

## グループ1: 案件→契約の流れ（4リレーション）

### 1-1. 案件情報 ↔ 発注者マスタ

```
案件情報.発注者 ↔ 発注者マスタ.関連案件
```

**ビジネスロジック:**
- 案件の商談段階から発注者を紐付ける
- 発注者ごとの案件一覧を把握

**用途:**
- 営業活動の管理
- 顧客別の案件状況確認

---

### 1-2. 案件情報 ↔ 工事契約

```
案件情報.契約情報 ↔ 工事契約.元案件
```

**ビジネスロジック:**
- 商談成立後、案件が契約に移行
- 案件から契約へのトレーサビリティ

**用途:**
- 受注率の分析
- 案件→契約の変換履歴

---

### 1-3. 工事契約 ↔ 発注者マスタ

```
工事契約.発注者 ↔ 発注者マスタ.契約履歴
```

**ビジネスロジック:**
- 契約書に記載される正式な発注者
- 発注者ごとの契約実績管理

**用途:**
- 取引先別の受注管理
- 与信管理

---

### 1-4. 工事契約 ↔ 資格者マスタ（現場責任者）

```
工事契約.現場責任者 ↔ 資格者マスタ.責任者として担当した工事
```

**ビジネスロジック:**
- 各工事に現場所長（監理技術者）を配置
- 資格者の経験実績管理

**用途:**
- 監理技術者の配置計画
- 資格者の工事経験の記録

---

## グループ2: 工程階層構造（4リレーション）

### 2-1. 工事契約 ↔ 大工程

```
工事契約.関連大工程 ↔ 大工程.所属工事
```

**ビジネスロジック:**
- 工事を大工程に分解（準備工、基礎工、躯体工など）
- WBS（Work Breakdown Structure）の第1レベル

**用途:**
- 工事の大枠スケジュール管理
- マイルストーン設定

---

### 2-2. 大工程 ↔ 中工程

```
大工程.関連中工程 ↔ 中工程.所属大工程
```

**ビジネスロジック:**
- 大工程をさらに詳細な中工程に分解
- WBSの第2レベル

**用途:**
- 詳細スケジュール管理
- 進捗管理の粒度調整

---

### 2-3. 中工程 ↔ 小工程

```
中工程.関連小工程 ↔ 小工程.所属中工程
```

**ビジネスロジック:**
- 中工程を実作業単位の小工程に分解
- WBSの第3レベル（最小単位）

**用途:**
- 日次作業計画
- 詳細な進捗管理

---

### 2-4. 小工程 ↔ 工種マスタ

```
小工程.工種 ↔ 工種マスタ.使用実績
```

**ビジネスロジック:**
- 各作業を工種（型枠、鉄筋、コンクリートなど）に分類
- 工種別の原価管理

**用途:**
- 工種別の工数・原価集計
- 標準歩掛の算出

---

## グループ3: リソース配置（人員）（3リレーション）

### 3-1. 小工程 ↔ 人員配置

```
小工程.配置人員 ↔ 人員配置.配置先工程
```

**ビジネスロジック:**
- 作業に必要な人員を配置
- 日次の人員計画

**用途:**
- 作業班編成
- 人工数の計画・実績管理

---

### 3-2. 人員配置 ↔ 資格者マスタ

```
人員配置.作業者 ↔ 資格者マスタ.配置履歴
```

**ビジネスロジック:**
- 資格保有者を適切な工程に配置
- 有資格者の稼働管理

**用途:**
- 資格者の配置計画
- 技能者の経験蓄積

---

### 3-3. 大工程 ↔ 人員配置

```
大工程.大工程の配置人員 ↔ 人員配置.配置先大工程
```

**ビジネスロジック:**
- 大工程レベルでの人員計画
- 長期的なリソース配分

**用途:**
- 工事全体の人員計画
- ピーク時の人員調整

---

## グループ4: リソース配置（機材）（3リレーション）

### 4-1. 小工程 ↔ 機材配置

```
小工程.使用機材 ↔ 機材配置.配置先工程
```

**ビジネスロジック:**
- 作業に必要な機材を配置
- 機材の日次運用計画

**用途:**
- 重機・車両の配車計画
- 機材レンタル管理

---

### 4-2. 機材配置 ↔ 資機材マスタ

```
機材配置.機材 ↔ 資機材マスタ.配置履歴
```

**ビジネスロジック:**
- 保有機材を工程に割り当て
- 機材の稼働実績管理

**用途:**
- 機材の稼働率分析
- 保有機材の適正化

---

### 4-3. 大工程 ↔ 機材配置

```
大工程.大工程の使用機材 ↔ 機材配置.配置先大工程
```

**ビジネスロジック:**
- 大工程レベルでの機材計画
- 長期的な機材確保

**用途:**
- 工事全体の機材計画
- 重機の手配スケジュール

---

## グループ5: 協力会社発注（3リレーション）

### 5-1. 小工程 ↔ 協力会社発注

```
小工程.協力会社発注 ↔ 協力会社発注.対象工程
```

**ビジネスロジック:**
- 自社施工できない工程を協力会社に発注
- 専門工事の外注管理

**用途:**
- 外注工事の管理
- 協力会社との契約管理

---

### 5-2. 協力会社発注 ↔ 協力会社マスタ

```
協力会社発注.発注先 ↔ 協力会社マスタ.受注履歴
```

**ビジネスロジック:**
- 専門工事業者に作業を委託
- 協力会社の実績管理

**用途:**
- 協力会社の選定
- 協力会社評価

---

### 5-3. 工事契約 ↔ 協力会社発注

```
工事契約.全協力会社発注 ↔ 協力会社発注.親工事契約
```

**ビジネスロジック:**
- 工事単位での外注管理
- 外注費の予実管理

**用途:**
- 工事別の外注費集計
- 外注比率の分析

---

## グループ6: 作業実績記録（4リレーション）

### 6-1. 小工程 ↔ 作業日報

```
小工程.作業日報 ↔ 作業日報.対象工程
```

**ビジネスロジック:**
- 毎日の作業内容と進捗を記録
- 日次の実績管理

**用途:**
- 進捗の日次追跡
- 工数実績の記録

---

### 6-2. 作業日報 ↔ 資格者マスタ

```
作業日報.作業者 ↔ 資格者マスタ.日報記録
```

**ビジネスロジック:**
- 誰がどの作業をしたか記録
- 個人別の作業実績

**用途:**
- 作業者の稼働管理
- 技能者の経験記録

---

### 6-3. 作業日報 ↔ 協力会社マスタ

```
作業日報.協力会社作業者 ↔ 協力会社マスタ.作業実績
```

**ビジネスロジック:**
- 協力会社の稼働実績を記録
- 外注工数の管理

**用途:**
- 協力会社の稼働集計
- 外注費の精算

---

### 6-4. 工事契約 ↔ 作業日報

```
工事契約.全日報 ↔ 作業日報.所属工事
```

**ビジネスロジック:**
- 工事単位での日報管理
- 工事全体の稼働状況把握

**用途:**
- 工事の進捗サマリー
- 月次報告書作成

---

## グループ7: 安全管理（6リレーション）

### 7-1. 工事契約 ↔ 安全パトロール

```
工事契約.安全パトロール記録 ↔ 安全パトロール.対象工事
```

**ビジネスロジック:**
- 定期的な安全巡回の記録
- 工事の安全管理

**用途:**
- 安全管理計画の実施確認
- 安全監査対応

---

### 7-2. 安全パトロール ↔ 資格者マスタ

```
安全パトロール.パトロール実施者 ↔ 資格者マスタ.パトロール実施履歴
```

**ビジネスロジック:**
- 安全管理者が実施
- 有資格者の責任明確化

**用途:**
- 安全管理者の活動記録
- 安全教育の実施確認

---

### 7-3. 小工程 ↔ 安全パトロール

```
小工程.安全パトロール ↔ 安全パトロール.対象工程
```

**ビジネスロジック:**
- 各工程の安全状況を確認
- 工程別の安全リスク管理

**用途:**
- 危険作業の重点パトロール
- 工程別の安全指導

---

### 7-4. 工事契約 ↔ KY活動記録

```
工事契約.KY活動記録 ↔ KY活動記録.対象工事
```

**ビジネスロジック:**
- 危険予知活動の実施記録
- 工事の安全文化醸成

**用途:**
- KY活動の実施管理
- 安全意識の向上

---

### 7-5. 小工程 ↔ KY活動記録

```
小工程.KY活動 ↔ KY活動記録.対象工程
```

**ビジネスロジック:**
- 作業開始前の危険予知
- 工程別のリスク抽出

**用途:**
- 作業前のリスク確認
- 安全対策の立案

---

### 7-6. KY活動記録 ↔ 資格者マスタ

```
KY活動記録.参加者 ↔ 資格者マスタ.KY活動参加履歴
```

**ビジネスロジック:**
- 作業員全員でリスクを共有
- 参加者の記録

**用途:**
- KY活動の参加率管理
- 安全教育の実施確認

---

## グループ8: 品質管理（3リレーション）

### 8-1. 小工程 ↔ 検査記録

```
小工程.検査記録 ↔ 検査記録.対象工程
```

**ビジネスロジック:**
- 各工程の完了時に検査実施
- 品質基準の遵守確認

**用途:**
- 工程検査の管理
- 品質記録の保管

---

### 8-2. 検査記録 ↔ 資格者マスタ

```
検査記録.検査実施者 ↔ 資格者マスタ.検査実施履歴
```

**ビジネスロジック:**
- 有資格者が検査を実施
- 検査員の責任明確化

**用途:**
- 検査員の配置計画
- 検査能力の管理

---

### 8-3. 工事契約 ↔ 検査記録

```
工事契約.全検査記録 ↔ 検査記録.所属工事
```

**ビジネスロジック:**
- 工事単位での品質管理
- 検査記録の一元管理

**用途:**
- 工事の品質サマリー
- 竣工検査対応

---

## グループ9: 横断的リレーション（2リレーション）

### 9-1. 大工程 ↔ 作業日報

```
大工程.大工程の日報 ↔ 作業日報.所属大工程
```

**ビジネスロジック:**
- 大工程レベルでの日報集計
- 大工程の進捗把握

**用途:**
- 大工程単位の進捗サマリー
- 工程会議資料作成

---

### 9-2. 中工程 ↔ 作業日報

```
中工程.中工程の日報 ↔ 作業日報.所属中工程
```

**ビジネスロジック:**
- 中工程レベルでの日報集計
- 中工程の進捗把握

**用途:**
- 中工程単位の進捗サマリー
- 詳細工程管理

---

## リレーション設計図

```
                        【マスタ系】
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │ 発注者マスタ  │  │ 資格者マスタ  │  │協力会社マスタ│
    └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
           │                    │                    │
           │                    │                    │
    ┌──────────────┐  ┌─────────────┐  ┌─────────────┐
    │ 資機材マスタ   │  │  工種マスタ   │  │               │
    └──────┬──────┘  └──────┬──────┘  │               │
           │                    │         │               │
           │                    │         │               │
                        【案件・契約系】      │               │
    ┌─────────────┐                    │               │
    │   案件情報    │←───────────────┘               │
    └──────┬──────┘                                    │
           │                                            │
           ↓                                            │
    ┌─────────────┐                                    │
    │   工事契約    │←───────────────────────────────┘
    └──────┬──────┘
           │
           ├─────────┬─────────┬─────────┐
           │         │         │         │
           ↓         ↓         ↓         ↓
    ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐
    │ 大工程 │  │安全パト│  │KY活動 │  │協力発注│
    └───┬──┘  │ロール │  │記録  │  └───┬──┘
        │     └──────┘  └──────┘      │
        ├─────────┐                    │
        │         │                    │
        ↓         ↓                    ↓
    ┌──────┐  ┌──────┐         ┌──────────┐
    │ 中工程 │  │人員配置│         │協力会社マスタ│
    └───┬──┘  └───┬──┘         └──────────┘
        │         │
        ↓         ↓
    ┌──────┐  ┌──────┐
    │ 小工程 │  │資格者マスタ│
    └───┬──┘  └──────────┘
        │
        ├─────────┬─────────┬─────────┐
        │         │         │         │
        ↓         ↓         ↓         ↓
    ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐
    │人員配置│  │機材配置│  │作業日報│  │検査記録│
    └───┬──┘  └───┬──┘  └──────┘  └──────┘
        │         │
        ↓         ↓
    ┌──────┐  ┌──────┐
    │資格者  │  │資機材  │
    │マスタ  │  │マスタ  │
    └──────┘  └──────┘
```

---

## 実装方法

### 1. スクリプト実行

```bash
cd /Users/hiroki-matsui/dev/miyabi_0.15/LarkConst/construction-lark
npx tsx scripts/complete-relations-setup.ts
```

### 2. 実行結果

- 新規作成されたリレーション数
- スキップされた既存リレーション数
- カテゴリ別の成功率
- 設定されたリレーション一覧

### 3. 確認方法

Lark Baseの各テーブルで、新しく追加されたリンクフィールドを確認できます。

---

## リレーション活用例

### 例1: 工事の人員稼働状況を確認

```
工事契約 → 大工程 → 中工程 → 小工程 → 人員配置 → 資格者マスタ
```

### 例2: 協力会社の受注実績を分析

```
協力会社マスタ → 受注履歴（協力会社発注） → 対象工程（小工程） → 所属工事（工事契約）
```

### 例3: 資格者の経験を追跡

```
資格者マスタ → 配置履歴（人員配置） → 配置先工程（小工程） → 所属工事（工事契約）
```

### 例4: 機材の稼働率を分析

```
資機材マスタ → 配置履歴（機材配置） → 配置先工程（小工程） → 所属工事（工事契約）
```

---

## 設計原則

1. **双方向性**: 全てのリレーションは双方向で設定
2. **階層性**: 工程は大→中→小の3階層構造
3. **トレーサビリティ**: 案件→契約→工程→実績の流れを追跡可能
4. **リソース管理**: 人員・機材を工程に紐付け
5. **品質・安全**: 検査・パトロール・KY活動を工程に紐付け
6. **実績記録**: 日報を工程・工事・作業者に紐付け

---

## まとめ

この設計により、以下が実現されます:

- ✅ 工事情報の一元管理
- ✅ リソース（人・機材）の可視化
- ✅ 進捗の多角的な分析
- ✅ 安全・品質記録の追跡
- ✅ 協力会社管理の効率化
- ✅ 発注者別の実績管理
- ✅ ガントチャート生成の基盤

全36リレーションが建設業の実務フローを完全にカバーしています。

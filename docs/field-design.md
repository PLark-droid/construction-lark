# フィールド設計書

## 概要

このドキュメントでは、2重入力を削減するためのフィールド設計について説明します。

**設計原則**: 同じデータを複数箇所に入力させない

---

## フィールドタイプ一覧

| タイプ | 用途 | 2重入力削減効果 |
|-------|------|----------------|
| リンク (Link) | 他テーブル参照 | ★★★ 手入力を完全排除 |
| Lookup | リンク先の値を表示 | ★★★ 自動転記 |
| 数式 (Formula) | 自動計算 | ★★★ 計算値の手入力排除 |
| 単一選択 | 定型値の選択 | ★★ 入力ミス防止 |
| 自動採番 | ID自動生成 | ★★ 番号管理の自動化 |

---

## 1. リンクフィールド設計

### 資格記録テーブル

| フィールド | 旧設計 | 新設計 | 効果 |
|-----------|--------|--------|------|
| 従業員名 | テキスト入力 | 従業員マスタへのリンク | 選択式で入力ミス0 |
| 資格名 | テキスト入力 | 資格マスタへのリンク | 選択式で入力ミス0 |

**設定方法**:
```
フィールドタイプ: リンク
リンク先テーブル: 従業員マスタ v2
表示フィールド: 氏名
```

### 工程管理テーブル

| フィールド | 旧設計 | 新設計 | 効果 |
|-----------|--------|--------|------|
| 案件名 | テキスト入力 | 案件管理へのリンク | 選択式 |
| 担当者 | テキスト入力 | 従業員マスタへのリンク | 選択式 |
| 必要資格 | テキスト入力 | 資格マスタへの複数リンク | 複数選択式 |

### 案件管理テーブル

| フィールド | 旧設計 | 新設計 | 効果 |
|-----------|--------|--------|------|
| 責任者 | テキスト入力 | 従業員マスタへのリンク | 選択式 |
| 担当者 | テキスト入力 | 従業員マスタへの複数リンク | 複数選択式 |

---

## 2. Lookupフィールド設計

### 資格記録テーブル

リンク先から自動で値を取得:

| Lookupフィールド | 参照元 | 取得フィールド |
|-----------------|--------|--------------|
| 従業員所属 | 従業員リンク | 所属 |
| 従業員連絡先 | 従業員リンク | 連絡先 |
| 資格カテゴリ | 資格リンク | カテゴリ |
| 更新周期 | 資格リンク | 更新周期（年） |

**効果**: 従業員の所属を資格記録に手入力する必要がなくなる

### 工程管理テーブル

| Lookupフィールド | 参照元 | 取得フィールド |
|-----------------|--------|--------------|
| 案件顧客名 | 案件リンク | 顧客名 |
| 案件状態 | 案件リンク | 状態 |
| 担当者連絡先 | 担当者リンク | 連絡先 |

---

## 3. 数式フィールド設計

### 資格記録テーブル

#### 次回更新予定（自動計算）
```
= IF(有効期限管理, DATEADD(取得日, 更新周期, "year"), "")
```

#### 残日数（期限まで）
```
= IF(有効期限, DATETIME_DIFF(有効期限, TODAY(), "days"), "")
```

#### 状態（自動判定）
```
= IF(残日数 < 0, "期限切れ",
    IF(残日数 < 30, "更新必要",
      IF(残日数 < 90, "注意", "有効")))
```

### 工程管理テーブル

#### 予定工期（日数）
```
= DATETIME_DIFF(終了予定日, 開始予定日, "days") + 1
```

#### 実績工期（日数）
```
= IF(終了実績日,
    DATETIME_DIFF(終了実績日, 開始実績日, "days") + 1,
    "")
```

#### 遅延日数
```
= IF(AND(状態 != "完了", TODAY() > 終了予定日),
    DATETIME_DIFF(TODAY(), 終了予定日, "days"),
    0)
```

#### 状態（自動判定）
```
= IF(進捗率 = 100, "完了",
    IF(進捗率 > 0, "進行中",
      IF(TODAY() >= 開始予定日, "進行中", "未着手")))
```

### 案件管理テーブル

#### 残日数（竣工まで）
```
= IF(状態 = "進行中",
    DATETIME_DIFF(竣工予定日, TODAY(), "days"),
    "")
```

#### 工期（日数）
```
= DATETIME_DIFF(竣工予定日, 着工日, "days") + 1
```

#### 進捗遅れ判定
```
= IF(AND(状態 = "進行中", 残日数 > 0),
    IF(進捗率 < (1 - 残日数/工期) * 100, "遅延", "順調"),
    "")
```

---

## 4. 単一選択フィールド設計

### 部署（所属）
```
選択肢:
- 建築部
- 土木部
- 設備部
- 管理部
- 営業部
```

### 役職
```
選択肢:
- 部長
- 課長
- 主任
- 一般
```

### 案件状態
```
選択肢:
- 計画中 (灰色)
- 進行中 (青色)
- 完了 (緑色)
- 中止 (赤色)
```

### 工程状態
```
選択肢:
- 未着手 (灰色)
- 進行中 (青色)
- 完了 (緑色)
- 保留 (黄色)
```

---

## 5. 自動採番設計

### 社員番号
```
形式: E001, E002, E003...
前置詞: E
桁数: 3
```

### 資格コード
```
形式: Q001, Q002, Q003...
前置詞: Q
桁数: 3
```

### 案件番号
```
形式: P2024-001, P2024-002...
前置詞: P{YEAR}-
桁数: 3
```

---

## 6. API実装（リンクフィールド対応）

### テーブル作成スクリプト

```typescript
// 従業員マスタへのリンクフィールド
{
  field_name: '従業員',
  type: FIELD_TYPES.LINK,  // 18
  property: {
    table_id: employeesTableId,  // リンク先テーブルID
    multiple: false,              // 単一選択
  }
}

// 資格マスタへの複数リンクフィールド
{
  field_name: '必要資格',
  type: FIELD_TYPES.LINK,  // 18
  property: {
    table_id: qualificationsTableId,
    multiple: true,  // 複数選択可
  }
}
```

### 数式フィールド

```typescript
{
  field_name: '残日数',
  type: FIELD_TYPES.FORMULA,  // 20
  property: {
    formula: 'DATETIME_DIFF({有効期限}, TODAY(), "days")'
  }
}
```

---

## 7. テーブル間関係図

```
┌─────────────────────────────────────────────────────────────┐
│                        従業員マスタ                          │
│  [社員番号] [氏名] [所属] [役職] [連絡先] [状態]             │
└─────────────────────────────────────────────────────────────┘
       │                    │                    │
       │←リンク             │←リンク             │←複数リンク
       ▼                    ▼                    ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│    資格記録      │  │    工程管理      │  │    案件管理      │
│                  │  │                  │  │                  │
│ [従業員]→Lookup  │  │ [担当者]→Lookup  │  │ [責任者]→Lookup  │
│   ├ 所属        │  │   ├ 連絡先      │  │ [担当者]→Lookup  │
│   └ 連絡先      │  │                  │  │                  │
│                  │  │ [案件]→Lookup   │  │                  │
│ [資格]→Lookup   │  │   ├ 顧客名      │  │                  │
│   ├ カテゴリ    │  │   └ 状態        │  │                  │
│   └ 更新周期    │  │                  │  │                  │
└──────────────────┘  └──────────────────┘  └──────────────────┘
       ▲                    │
       │←リンク             │
       │                    ▼
┌──────────────────┐  ┌──────────────────────────────────────┐
│    資格マスタ    │  │   工程管理 ← 案件管理 (1対多)        │
│                  │  │                                      │
│ [資格コード]     │  │   案件の進捗率 = 工程進捗率の平均    │
│ [資格名]         │  │   (Rollup数式で自動計算)             │
│ [カテゴリ]       │  └──────────────────────────────────────┘
│ [更新周期]       │
└──────────────────┘
```

---

## 8. 2重入力削減まとめ

### Before（旧設計）

```
資格記録を登録する場合:
1. 従業員名を手入力 ← 入力ミスの可能性
2. 資格名を手入力   ← 入力ミスの可能性
3. 所属を手入力     ← 従業員マスタと重複
4. 有効期限を入力
5. 次回更新予定を計算して入力 ← 計算ミスの可能性
```

### After（新設計）

```
資格記録を登録する場合:
1. 従業員をリンクから選択 ← ミス0
2. 資格をリンクから選択   ← ミス0
3. 所属は自動表示 (Lookup) ← 入力不要
4. 有効期限を入力
5. 次回更新予定は自動計算 (数式) ← 入力不要
```

**削減効果**: 5項目 → 3項目（40%削減）

---

## 次のステップ

1. 改善版テーブル作成スクリプトを実行
2. 既存データを移行
3. 動作確認

詳細は [ユーザーマニュアル](./user-manual.md) を参照。
